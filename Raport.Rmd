---
title: "Co wpływa na długość naszego życia?"
author: "Szymon Malec, Michał Wiktorowski"
output:
  pdf_document: 
    extra_dependencies: ["polski", "mathtools", "amsthm", "amssymb", "icomma", "upgreek", "xfrac", "scrextend", "float", "tabularx", "hyperref", "caption", "enumitem"]
---

\renewcommand{\figurename}{Wykres}
\renewcommand{\tablename}{Tablica}
\raggedbottom

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(zeallot)
library(tidyr)
library(knitr)
library(reshape2)
library(cowplot)

data <- read.csv("data/data.csv")
```


# Wstęp
<!-- Akapit - 6 spacji -->
|      W niniejszej pracy chcielibyśmy przeanalizować, jak poszczególne czynniki zewnętrzne wpływają na długość naszego życia. Jak się okazuje, jedne z nich są poważnym problemem, podczas gdy inne w niewielkim stopniu przyczyniają się na długość życia. Do analizy posłużymy się zbiorem danych charakteryzującym wiele państw świata pod kilkoma aspektami, między innymi takimi jak jakość edukacji, spożycie alkoholu, czy zapadalność na poszczególne choroby. Link do danych znajduje się [$\color{blue}{\text{tutaj}}$](https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who?fbclid=IwAR2HtwUPyioM4tHmuae7B2owTUB8q3XlmpP12LbTM9NYDsi4qtaWGOYoNDE).


# Opis danych


# Braki w danych
|      Zanim rozpoczniemy analizować nasze dane, sprawdźmy, czy zawierają one jakieś braki.

```{r, fig.width=6, fig.height=9}
nans <- data.frame()
years <- sort(unique(data$year))
for (y in years) {
    data_year <- data %>% filter(year == y)
    ns <- c()
    for (column in colnames(data_year[4:22])) {
        n <- sum(is.na(data_year[column]))
        ns <- append(ns, n)
    }
    nans <- rbind(nans, ns)
}
nans <- cbind(years, nans)
names(nans) <- colnames(data[c(2, 4:22)])
df <- data.frame(t(nans))
names(df) <- lapply(df[1, ], as.character)
df <- df[-1,1:16]
kable(df)
```


# Devoloped a developing
|      Spodziewamy się, że w krajach lepiej rozwiniętych długość życia jest większa niż w krajach uboższych. Żeby przekonać się, czy w rzeczywistości tak jest, porównamy średnie dla obu typów krajów dla każdego roku. Ponieważ państwa zawarte w danych znacznie różnią się populacją, nie możemy traktować ich na równi. Z tego powodu skorzystamy z średniej ważonej, gdzie wagami będą populacje.

```{r le_dd, fig.cap="\\label{fig:le_dd} Porównanie średniej długości życia dla krajów wysoko i słabo rozwiniętych", fig.align="center", fig.width = 5, fig.height = 3}

data_developed <- data %>% filter(status == 'Developed')
data_developing <- data %>% filter(status == 'Developing')

le1 <- c()
le2 <- c()
years <- sort(unique(data$year))

for (y in years) {
    data_year <- data_developed %>% filter(year == y & !is.na(life_expectancy) & !is.na(population))
    mean_lf <- sum(data_year$life_expectancy * data_year$population) / sum(data_year$population)
    le1 <- append(le1, mean_lf)
}

for (y in years) {
    data_year <- data_developing %>% filter(year == y & !is.na(life_expectancy) & !is.na(population))
    mean_lf <- sum(data_year$life_expectancy * data_year$population) / sum(data_year$population)
    le2 <- append(le2, mean_lf)
}

df <- melt(data.frame(years=years, y1=le1, y2=le2), id.var='years')
ggplot() + 
  geom_line(aes(x=years, y=le1, col='Developed')) + 
  geom_line(aes(x=years, y=le2, col='Developing')) + 
  scale_color_manual(values=c('#009000', 'red')) + xlab("Rok") + ylab("Średnia długość życia") + labs(col="")
```

Jak możemy zauważyć na powyższym wykresie, krzywa dla państw rozwiniętych znajduje się znacznie wyżej niż dla państw rozwijających się. W obu przypadkach jednak dostrzec można w miarę podobny trend wzrostowy. Ponieważ w dalszej części pracy analizowane będą kolumny z danymi dotyczącymi nauczania oraz PKB, spójrzmy już teraz na wykresy punktowe tych wartości z zaznaczeniem, które wartości pochodzą od krajów rozwiniętych, a które od rozwijających się.

```{r schooling_dd, fig.cap="\\label{fig:schooling_dd} Wykres punktowy długości życia od czasu nauczania", fig.align="center", fig.width = 5, fig.height = 3}
plt1 <- ggplot() + geom_point(aes(data$schooling, data$life_expectancy, col=data$status), alpha=0.3, size=0.6) +
scale_color_manual(values=c('#1cb900', '#ce0000')) + xlab("Lata nauki") + ylab("Długość życia") + theme(legend.position='none')

plt2 <- ggplot() + geom_point(aes(data$GDP, data$life_expectancy, col=data$status), alpha=0.3, size=0.6) +
scale_color_manual(values=c('#1cb900', '#ce0000')) + xlab("PKB") + ylab("Długość życia") + labs(col="")

plot_grid(plt1, plt2)
```

Na obu wykresach zauważyć można, że państwa lepiej rozwinięte wyróżniają się długim czasem nauczania, wysokim PKB oraz długim czasem życia. W dalszej części analizy państwa te traktowane będą jako wzór do osiągnięcia długowieczności.


# Analiza
|      Jednym z głównych celów raportu jest sprawdzenie, które czynniki mają największy wpływ na długość życia. Dobrym początkiem będzie narysowanie wykresów punktowych długości życia od poszczególnych zmiennych. Wykresy takie dają wgląd na to, jak zachowują się dane oraz pozwalają ocenić, czy występuje między nimi jakaś korelacja. Dodatkowo skorzystamy ze współczynnika korelacji Spearmana, ponieważ jest to miara monotonicznej zależności, a właśnie takiej zależności szukamy. Wspomnianą korelację obliczymy między długością życia, a pozostałymi zmiennymi liczbowymi dla każdego roku z osobna.

Od razu możemy zauważyć, że rozrzut punktów na poszczególnych wykresach jest bardzo zróżnicowany. Na jednych wydaje się on być całkowicie losowy, natomiast na innych widać pewną zależność. Ze względu na to zróżnicowanie, nie użyjemy do sprawdzenia korelacji współczynnika Pearsona - sprawdza on jedynie zależność liniową. Można za to wykorzystać współczynnik korelacji Spearmana, który sprawdza zależność monotoniczną między danymi. Ze względu na silną korelację, poddamy głębszej analizie dwa czynniki - długość edukacji, oraz produkt krajowy brutto.

```{r scattery_le, fig.cap="\\label{fig:scattery_le} Scattery", fig.align="center", fig.width = 5, fig.height = 8}
data[4:22] %>%
  gather(-life_expectancy, key = "var", value = "value") %>% 
  ggplot(aes(x = value, y = life_expectancy)) +
    geom_point(size=0.4, alpha=0.4, col='#0575d0', stroke=0) +
    facet_wrap(~ var, scales='free', nrow=6) +
  scale_x_discrete() +
  scale_y_discrete() + theme(
  plot.title = element_text(hjust = 0.5, size = 24),
)
```

```{r}
correlations <- data.frame()
years <- sort(unique(data$year))
for (y in years) {
    data_year <- data %>% filter(year == y)
    rs <- c()
    for (column in colnames(data_year[5:22])) {
        r <- cor(data_year$life_expectancy, data_year[column], use="pairwise.complete.obs", method="spearman")
        rs <- append(rs, round(r, 2))
    }
    correlations <- rbind(correlations, rs)
}
correlations <- cbind(years, correlations)
names(correlations) <- colnames(data[c(2, 5:22)])
df <- data.frame(t(correlations), header=TRUE)
names(df) <- lapply(df[1, ], as.character)
df <- df[-1,1:16]
kable(df)
```

\newpage

### Edukacja
|      Jako pierwsze przeanalizujemy wpływ czasu edukacji na oczekiwaną długość życia. Zależność w danych przypomina liniową (wykres o nazwie "schooling"). Do zbadania korelacji możemy zatem użyć współczynnika korelacji Pearsona. Przyjmuje wartość $R \approx 0,752$, więc jest to mocna korelacja. Dzięki niej możemy również dopasować do danych prostą regresji korzystając z metody najmniejszych kwadratów.

```{r}
regression <- function(X, Y, display_plot=TRUE){
    r <- cor(X, Y, use="pairwise.complete.obs")
    Sx <- sd(X)
    Sy <- sd(Y)
    a <- r * Sy / Sx
    b <- mean(Y) - a * mean(X)

    if(display_plot){
        xs <- seq(min(X), max(X), 0.01)
        plt <- ggplot() +
            geom_point(aes(x=X, y=Y), alpha=0.5) +
            geom_line(aes(x = xs, y = a * xs + b), linewidth=1, col="red")
        show(plt)
    }
    else{
      return(c(a, b))
    }
}
```

```{r scatter_schooling, fig.cap="\\label{fig:scatter_schooling} Prosta regresji dla danych", fig.align="center", fig.width = 4, fig.height = 3}
df <- data[(!is.na(data$schooling)) & (!is.na(data$life_expectancy)),]
regression(df$schooling, df$life_expectancy)
```
|      Kolejnym punktem będzie analiza residuów. Sprawdźmy na histogramie jak wygląda rozkład wartości błędów.

```{r hist_schooling, fig.cap="\\label{fig:hist_schooling} Histogram residuów", fig.align="center", fig.width = 4, fig.height = 3}
ab <- regression(df$schooling, df$life_expectancy, display_plot = FALSE)
a <- ab[1]
b <- ab[2]
e <- df$life_expectancy - a*df$schooling - b
hist_e <- ggplot(data.frame(e = e), aes(e)) + geom_histogram(aes(y = after_stat(density)), fill = 'white', color = 'black')
hist_e
```
Kształt histogramu jest zbliżony do krzywej gaussowskiej. Sprawdźmy czy rozkład residuów jest z rozkładu normalnego. W tym celu posłużymy się testem Kołmogorowa-Smirnova. .....

### PKB


# Polska


# Jak długo żyją inni?
|      Jak już wspomnieliśmy - długość życia zależy od wielu czynników i dla każdego państwa na świecie inaczej się one charakteryzują. Rozważmy na początku dane z 2015 roku - najnowsze, którymi dysponujemy. Średnia długość życia na globie wyniosła wtedy 71,62 lata. Jednak rozrzut danych dla poszczególnych państw jest duży. Mianem najdłużej żyjących ludzi mogli się wtedy poszczycić Słoweńczycy z imponującą średnią życia aż 88 lat. Natomiast najkrócej żyjącymi ludźmi okazali się być obywatele Sierra Leony z wynikiem zaledwie 51 lat. Polacy osiągneli wynik 77.5 lat, co stawia nas na 42 miejscu w rankingu - wynik dobry, ale nie najlepszy.

```{r barplot, fig.cap="\\label{fig:barplot} Polska a inne państwa", fig.width = 5, fig.height = 4, fig.align="center"}

#średnia długość życia dla państw
df <- data[data$year == 2015,]
df <- arrange(df, desc(life_expectancy))

bar2 <- ggplot(data = rbind(head(df, 5), df[df$country == 'Poland',], tail(df, 5)), mapping = aes(reorder(country, -life_expectancy, sum), life_expectancy)) + 
  geom_bar(stat = 'identity', fill = c('light green', 'light green', 'light green', 'light green', 'light green', 'gold', 'orangered', 'orangered', 'orangered', 'orangered', 'orangered'), color = 'black') +
  theme(axis.text.x = element_text(angle = 90), axis.title.x = element_blank()) +
  labs(y = 'Life expectancy') +
  geom_hline(yintercept = mean(df$life_expectancy), color = 'purple')

bar2
```


# Podsumowanie
