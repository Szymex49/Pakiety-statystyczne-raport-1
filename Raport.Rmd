---
title: "Co wpływa na długość naszego życia?"
author: "Szymon Malec, Michał Wiktorowski"
output:
  pdf_document: 
    extra_dependencies: ["polski", "mathtools", "amsthm", "amssymb", "icomma", "upgreek", "xfrac", "scrextend", "float", "tabularx", "hyperref", "caption", "enumitem"]
---

\renewcommand{\figurename}{Wykres}
\renewcommand{\tablename}{Tablica}
\raggedbottom

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(zeallot)
library(tidyr)
library(knitr)
library(reshape2)
library(cowplot)

data <- read.csv("data/data.csv")
data2014 <- data %>% filter(year == 2014)
data2015 <- data %>% filter(year == 2015)
```




# Wstęp
<!-- Akapit - 6 spacji -->
|      W niniejszej pracy chcielibyśmy przeanalizować, jak poszczególne czynniki zewnętrzne wpływają na długość naszego życia. Jak się okazuje, jedne z nich są poważnym problemem, podczas gdy inne w niewielkim stopniu przyczyniają się na długość życia. Do analizy posłużymy się zbiorem danych charakteryzującym wiele państw świata pod kilkoma aspektami, między innymi takimi jak jakość edukacji, spożycie alkoholu, czy zapadalność na poszczególne choroby. Link do danych znajduje się [$\color{blue}{\text{tutaj}}$](https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who?fbclid=IwAR2HtwUPyioM4tHmuae7B2owTUB8q3XlmpP12LbTM9NYDsi4qtaWGOYoNDE).





# Opis danych
|      Przed rozpoczęciem głównej analizy omówimy krótko, o czym nam mówi każda kolumna w tabeli danych.
\begin{itemize}

\item A country - kolumna ta zawiera nazwy państw, które zostały uwzględnione w zbiorze danych. W sumie są to 193 różne państwa.

\item Year - kolumna z latami. Zebrane dane pochodzą z lat 2000-2015.

\item A status - odnosi się do stopnia rozwoju państw. Jest podzielona na dwie zasadnicze kategorie: developing, czyli państwa wciąż rozwijające się (stanowią 83% wszystkich wartości), oraz developed, czyli te już rozwinięte (pozostałe 17%).

\item Life expectancy - czyli oczekiwana długość życia. Podana jest w latach.

\item Adult mortality - mówi nam o śmiertelności wśród osób dorosłych. Podane wartości oznaczają liczbę zgonów osób między 15, a 60 rokiem życia przypadającą na 1000 osób.

\item Infant deaths - oznacza śmiertelność wśród niemowląt/dzieci. Również podana w liczbie śmierci przypadającej na 1000 osób.

\item Alcohol - przeciętna konsumpcja alkoholu u osób powyżej 15 roku życia w ciągu roku. Podana jako liczba czystego alkoholu w litrach.

\item Percentage expenditure - wydatki na zdrowie jako procent PKB per capita.

\item Hepatitis B - odporność na zapalenie wątroby typu B wśród 1-latków podana w procentach.

\item Measles (?) - liczba zanotowanych przypadków Odry na 1000 osób. 

\item BMI - przeciętny indeks BMI całej populacji danego kraju.

\item Under-five deaths - liczba zgonów osób w wieku poniżej 5 lat na 1000 osób.

\item Polio - odporność na polio wśród 1-latków podana w procentach.

\item Total expenditure - wydatki rządu na zdrowie jako procent wszystkich wydatków.

\item Diphtheria - odporność na błonicę wśród 1-latków podana w procentach.

\item HIV/AIDS - ilość zgonów na HIV/AIDS wśród niemowlaków (0-4 lata) na 1000 osób.

\item GDP - produkt krajowy brutto (PKB) podany w dolarach.

\item Population - populacja danego kraju.

\item Thinness 1-19 years - proporcja osób chudych wśród osób w wieku 10-19 lat. Wyrażona w procentach.

\item Thinness 5-9 years - proporcja osób chudych wśród osób w wieku 5-9 lat. Wyrażona w procentach.

\item Income composition (?) - współczynnik rozwoju populacji danego kraju w kategorii dochodu ze źródeł. Podany jako liczba od 0 do 1.

\item Schooling - liczba lat edukacji podana w latach.

\end{itemize}



# Braki w danych
|      Zanim przejdziemy do analizy naszych danych, sprawdźmy, czy zawierają one jakieś braki. W tym celu zliczamy wszystkie brakujące wartości dla każdej zmiennej liczbowej w każdym roku.

```{r tabela_na, fig.cap="\\label{fig:tabela_na} Liczba brakujących wartości dla każdej zmiennej liczbowej w każdym roku."}
nans <- data.frame()
years <- sort(unique(data$year))
for (y in years) {
    data_year <- data %>% filter(year == y)
    ns <- c()
    for (column in colnames(data_year[4:22])) {
        n <- sum(is.na(data_year[column]))
        ns <- append(ns, n)
    }
    nans <- rbind(nans, ns)
}
nans <- cbind(years, nans)
names(nans) <- colnames(data[c(2, 4:22)])
df <- data.frame(t(nans))
names(df) <- lapply(df[1, ], as.character)
df <- df[-1,1:16]
kable(df)
```





# Devoloped a developing
|      Spodziewamy się, że w krajach lepiej rozwiniętych długość życia jest większa niż w krajach uboższych. Żeby przekonać się, czy w rzeczywistości tak jest, porównamy średnie dla obu typów krajów dla każdego roku. Ponieważ państwa zawarte w danych znacznie różnią się populacją, nie możemy traktować ich na równi. Z tego powodu skorzystamy z średniej ważonej, gdzie wagami będą populacje.

```{r le_dd, fig.cap="\\label{fig:le_dd} Porównanie średniej długości życia dla krajów wysoko i słabo rozwiniętych", fig.align="center", fig.width = 5, fig.height = 3}

data_developed <- data %>% filter(status == 'Developed')
data_developing <- data %>% filter(status == 'Developing')

le1 <- c()
le2 <- c()
years <- sort(unique(data$year))

for (y in years) {
    data_year <- data_developed %>% filter(year == y & !is.na(life_expectancy) & !is.na(population))
    mean_lf <- sum(data_year$life_expectancy * data_year$population) / sum(data_year$population)
    le1 <- append(le1, mean_lf)
}

for (y in years) {
    data_year <- data_developing %>% filter(year == y & !is.na(life_expectancy) & !is.na(population))
    mean_lf <- sum(data_year$life_expectancy * data_year$population) / sum(data_year$population)
    le2 <- append(le2, mean_lf)
}

df <- melt(data.frame(years=years, y1=le1, y2=le2), id.var='years')
ggplot() + 
  geom_line(aes(x=years, y=le1, col='Developed')) + 
  geom_line(aes(x=years, y=le2, col='Developing')) + 
  scale_color_manual(values=c('#009000', 'red')) + xlab("Rok") + ylab("Średnia długość życia") + labs(col="")
```

Jak możemy zauważyć na powyższym wykresie, krzywa dla państw rozwiniętych znajduje się znacznie wyżej niż dla państw rozwijających się. W obu przypadkach jednak dostrzec można w miarę podobny trend wzrostowy. Ponieważ w dalszej części pracy analizowane będą kolumny z danymi dotyczącymi nauczania oraz PKB, spójrzmy już teraz na wykresy punktowe tych wartości z zaznaczeniem, które wartości dotyczą krajów rozwiniętych, a które rozwijających się.

```{r fig.width = 12, fig.height = 4}
plt1 <- ggplot() + geom_point(aes(data$schooling, data$life_expectancy, col=data$status), alpha=0.3, size=0.6) +
scale_color_manual(values=c('#1cb900', '#ce0000')) + xlab("Lata nauki") + ylab("Długość życia") + theme(legend.position='none')

```
```{r schooling_dd, fig.cap="\\label{fig:schooling_dd} Wykres punktowy długości życia od czasu nauczania", fig.width = 12, fig.height = 4} 
plt2 <- ggplot() + geom_point(aes(data$GDP, data$life_expectancy, col=data$status), alpha=0.3, size=0.6) +
scale_color_manual(values=c('#1cb900', '#ce0000')) + xlab("PKB") + ylab("Długość życia") + labs(col="")

plot_grid(plt1, plt2)
```

Na obu wykresach zauważyć można, że państwa lepiej rozwinięte wyróżniają się długim czasem nauczania, wysokim PKB oraz długim czasem życia. W dalszej części analizy państwa te traktowane będą jako wzór do osiągnięcia długowieczności.





# Analiza
|      Jednym z głównych celów raportu jest sprawdzenie, które czynniki mają największy wpływ na długość życia. Dobrym początkiem będzie narysowanie wykresów punktowych długości życia od poszczególnych zmiennych. Wykresy takie dają wgląd na to, jak zachowują się dane oraz pozwalają ocenić, czy występuje między nimi jakaś zależność. Dodatkowo skorzystamy ze współczynnika korelacji Spearmana, ponieważ jest to miara monotonicznej zależności, a właśnie takiej zależności szukamy. Wspomnianą korelację obliczymy między długością życia, a pozostałymi zmiennymi liczbowymi dla każdego roku z osobna.

```{r scattery_le, fig.cap="\\label{fig:scattery_le} Wykresy punktowe oczekiwanej długości życia od poszczególnych zmiennych.", fig.align="center", fig.width = 5, fig.height = 8}
data[4:22] %>%
  gather(-life_expectancy, key = "var", value = "value") %>% 
  ggplot(aes(x = value, y = life_expectancy)) +
    geom_point(size=0.4, alpha=0.4, col='#0575d0', stroke=0) +
    facet_wrap(~ var, scales='free', nrow=6) +
  scale_x_discrete() +
  scale_y_discrete() + theme(
  plot.title = element_text(hjust = 0.5, size = 24),
)
```

```{r tabela_korelacji, fig.cap="\\label{fig:tabela_korelacji} Tabela korelacji Spearmana między oczekiwaną długością życia, a poszczególnymi zmiennymi dla każdego roku."}
correlations <- data.frame()
years <- sort(unique(data$year))
for (y in years) {
    data_year <- data %>% filter(year == y)
    rs <- c()
    for (column in colnames(data_year[5:22])) {
        r <- cor(data_year$life_expectancy, data_year[column], use="pairwise.complete.obs", method="spearman")
        rs <- append(rs, round(r, 2))
    }
    correlations <- rbind(correlations, rs)
}
correlations <- cbind(years, correlations)
names(correlations) <- colnames(data[c(2, 5:22)])
df <- data.frame(t(correlations), header=TRUE)
names(df) <- lapply(df[1, ], as.character)
df <- df[-1,1:16]
kable(df)
```

Możemy zauważyć, że rozrzut punktów na poszczególnych wykresach jest bardzo zróżnicowany. Na jednych wydaje się on być całkowicie losowy, natomiast na innych widać pewną zależność. Z tabeli korelacji odczytać możemy, że najsilniejszą ujemną zależność z oczekiwanym czasem życia mają zmienne związane ze śmiertelnością oraz niedowaga. Natomiast pozytywną korelację przejawiają zmienne takie jak BMI, zasięg szczepień na błonicę oraz polio, PKB, a w szczególności średni czas nauczania i wskaźnik rozwoju społecznego. Wysoka korelacja tego ostatniego nie jest zaskoczeniem, ponieważ wskaźnik ten jest wyliczany m. in. z oczekiwanego czasu życia, a więc wartości te naturalnie są od siebie zależne. Interesująca może być za to zależność pomiędzy czasem życia, a nauczaniem. Na wykresie punktowym zauważyć można między nimi liniową korelację. Z kolei, jeśli spojrzymy na wykres dotyczący PKB, na myśl przychodzi nam zależność logarytmiczna. Aby dokładniej zbadać te zależności, poddamy wspomniane zmienne głębszej analizie.





### Edukacja
|      Jako pierwsze przeanalizujemy wpływ czasu edukacji na oczekiwaną długość życia. W tym przypadku rozważymy dane wyłącznie z 2015 roku. Na wykresie \ref{fig:scatter_schooling} można zauważyć liniową zależność danych, zatem do zbadania korelacji możemy użyć współczynnika korelacji Pearsona. Przyjmuje wartość $R \approx 0,752$, więc jest to mocna korelacja. Dzięki niej możemy również dopasować do danych prostą regresji korzystając z metody najmniejszych kwadratów.
Polega ona na znalezieniu takich współczynników $a, b$ dla których funkcja
$$S(a,b) = \sum_{i = 1}^n (y_i - ax_i - b)^2$$
przyjmuje wartość najmniejszą. Rozwiązaniem jest para współczynników
$$
    \begin{cases}
      a = R\frac{S_y}{S_x} \\
      b = \bar{y} - a\bar{x}
    \end{cases}
$$
gdzie $R$ jest współczynnikiem korelacji Pearsona, a $S_x, S_y$ są próbkowymi odchyleniami standardowymi.
```{r}
regression <- function(X, Y, display_plot=TRUE){
    r <- cor(X, Y, use="pairwise.complete.obs")
    Sx <- sd(X)
    Sy <- sd(Y)
    a <- r * Sy / Sx
    b <- mean(Y) - a * mean(X)

    if(display_plot){
        xs <- seq(min(X), max(X), 0.01)
        plt <- ggplot() +
            geom_point(aes(x=X, y=Y), alpha=0.5) +
            geom_line(aes(x = xs, y = a * xs + b), linewidth=1, col="red")
        show(plt)
    }
    else{
      return(c(a, b))
    }
}
```

```{r scatter_schooling, fig.cap="\\label{fig:scatter_schooling} Prosta regresji dla danych", fig.align="center", fig.width = 4, fig.height = 3}

df <- data[(!is.na(data$schooling)) & (!is.na(data$life_expectancy)) & (data$year == 2015),]
regression(df$schooling, df$life_expectancy)
```

\newpage
|      Kolejnym punktem będzie analiza residuów. Sprawdźmy na histogramie jak wygląda rozkład wartości błędów.

```{r hist_schooling, fig.cap="\\label{fig:hist_schooling} Histogram residuów", fig.align="center", fig.width = 4, fig.height = 3}
ab <- regression(df$schooling, df$life_expectancy, display_plot = FALSE)
a <- ab[1]
b <- ab[2]
e <- df$life_expectancy - a*df$schooling - b
hist_e <- ggplot(data.frame(e = e), aes(e)) + geom_histogram(aes(y = after_stat(density)), fill = 'white', color = 'black')
hist_e
```

Kształt histogramu jest zbliżony do krzywej gaussowskiej. Sprawdźmy czy rozkład residuów jest z rozkładu normalnego. W tym celu posłużymy się testem Kołmogorowa-Smirnova. Przedstawmy hipotezy:

\begin{itemize}
\item $\mathcal{H}_0$: wartości residuów są z rozkładu normalnego
\item $\mathcal{H}_1$: wartości residuów nie są z rozkładu normalnego
\end{itemize}

```{r, echo = FALSE, eval = TRUE}
test <- ks.test(e, 'pnorm', mean(e), sd(e))
test
```

Niech $\alpha = 0,05$ będzie poziomem istotności naszego testu. Wyznaczona p-wartość wynosi $p = 0,2532$. Ponieważ jest ona większa od wartości $\alpha$ to nie mamy podstaw do odrzucenia hipotezy zerowej i na zadanym poziomie istotności możemy przyjąć, że dane pochodzą z rozkładu normalnego. 





### PKB

Podobnie jak w przypadku długości edukacji, będziemy analizować dane dotyczące PKB wyłącznie z 2015 roku. W przeciwieństwie do poprzedniego przypadku, dane te nie mają zależności liniowej, a kształtem przypomina bardziej logarytmiczną. W tym celu, zrobimy transformację danych do postaci liniowej, żeby móc później skorzystać z metody najmniejszych kwadratów. Innymi słowy $\tilde{x} = \log(x)$

```{r scatter_gdp, fig.cap="\\label{fig:scatter_gdp} Zależność długości życia od PKB w 2015 roku", fig.align="center", fig.width = 6, fig.height = 2}
df2 <- data[(!is.na(data$GDP)) & (!is.na(data$life_expectancy)) & (data$year == 2015),]
scat2 <- ggplot(data = df2, mapping = aes(x = GDP, y = life_expectancy)) + geom_point()
```


```{r scatter_gdp_line, fig.cap="\\label{fig:scatter_gdp_line} Transformacja danych do postaci liniowej", fig.align="center", fig.width = 6, fig.height = 2}
scat2_mod <- ggplot(data = df2, mapping = aes(x = log(GDP), y = life_expectancy)) + geom_point()
plot_grid(scat2, scat2_mod)
```
\newpage
Następnie dopasowujemy prostą regresji z MNK. Ostatecznie wykonujemy transformację odwrotną dla danych, wraz z wyznaczoną prostą, co w rezultacie da krzywą logarytmiczną dopasowaną do danych.

```{r reg_gdp, fig.cap="\\label{fig:reg_gdp} Prosta regresji dla przetransformowanych danych", fig.align="center", fig.width = 6, fig.height = 2}
c(a1, b1) %<-% regression(log(df2$GDP), df2$life_expectancy, FALSE)
xs1 <- seq(min(log(df2$GDP)), max(log(df2$GDP)), 0.1)
reg2 <- ggplot() + geom_point(aes(log(df2$GDP), df2$life_expectancy), alpha = 0.5) + geom_line(aes(xs1, a1*xs1 + b1), col='red', linewidth=1)
```

```{r reg_gdp_final, fig.cap="\\label{fig:reg_gdp_final} Regresja logarytmiczna orginalnych danych", fig.align="center", fig.width =6, fig.height = 2}
c(a2, b2) %<-% regression(log(df2$GDP), df2$life_expectancy, FALSE)
xs2 <- seq(0.1, max(df2$GDP), 10)
reg2_final <- ggplot() + geom_point(aes(df2$GDP, df2$life_expectancy), alpha = 0.5) + geom_line(aes(xs2, a2*log(xs2) + b2), col='red', linewidth=1)
plot_grid(reg2, reg2_final)
```
Następnie zbadamy czy residua mają jakiś rozkład. Pomoże nam w tym histogram.

```{r hist_gdp, fig.cap="\\label{fig:hist_gdp} Histogram residuów", fig.align="center", fig.width = 4, fig.height = 3}
e <- df2$life_expectancy - a2*log(df2$GDP) - b2
hist_e <- ggplot(data.frame(e = e), aes(e)) + geom_histogram(aes(y = after_stat(density)), fill = 'white', color = 'black')
hist_e
```

Średnia residuów $\mu_e = 0$ natomiast odchylenie standardowe $\sigma_e \approx 7,07$. Z kształtu histogramu można przypuszczać, że wartości residuów pochodzą z rozkładu normalnego. Aby zweryfikować tą hipotezę, ponownie posłużymy się testem Kołmogorowa-Smirnova na poziomie istotności $\alpha = 0,05$.

```{r, echo = FALSE, eval = TRUE}
test <- ks.test(e, 'pnorm', mean(e), sd(e))
test
```
Jak pokazuje wynik p-wartość $p = 0,9126$ jest znacznie większa od poziomu istotności $\alpha$. Nie mamy zatem podstaw do odrzucenia hipotezy o braku normalności tego rozkładu. Możemy zatem przyjąć, że rozkład residuów jest rozkładem normalnym $\mathcal{N}(\mu_e, \sigma_e) = \mathcal{N}(0, 7,07)$.

# Polska
|      Wyniki przeprowadzonych analiz wykorzystamy, by określić co pozwoliłoby Polsce wydłużyć średni czas życia. Zacznijmy od porównania Polski z resztą świata. Rozważymy dane z 2015 roku - najnowsze, którymi dysponujemy. Średnia długość życia na globie wyniosła wtedy 71,62 lata. Mianem najdłużej żyjących ludzi mogli się wtedy poszczycić Słoweńczycy z imponującą średnią życia aż 88 lat. Natomiast najkrócej żyjącymi ludźmi okazali się być obywatele Sierra Leony z wynikiem zaledwie 51 lat. Polacy osiągneli wynik 77.5 lat, co stawia nas na 42 miejscu w rankingu - wynik dobry, ale nie najlepszy.

```{r barplot, fig.cap="\\label{fig:barplot} Porównanie oczekiwanej długości życia w Polsce z pięcioma najwyższymi wartościami oraz pięcioma najniższymi wartościami.", fig.width = 5, fig.height = 4, fig.align="center"}

#średnia długość życia dla państw
df <- data[data$year == 2015,]
df <- arrange(df, desc(life_expectancy))

bar2 <- ggplot(data = rbind(head(df, 5), df[df$country == 'Poland',], tail(df, 5)), mapping = aes(reorder(country, -life_expectancy, sum), life_expectancy)) + 
  geom_bar(stat = 'identity', fill = c('light green', 'light green', 'light green', 'light green', 'light green', 'orangered', 'gold', 'gold', 'gold', 'gold', 'gold'), color = 'black') +
  theme(axis.text.x = element_text(angle = 90), axis.title.x = element_blank()) +
  labs(y = 'Długość życia') +
  geom_hline(yintercept = mean(df$life_expectancy), color = 'blue', size=1)

bar2
```

Zdefiniujmy statystykę $Z$ w następujący sposób
$$ Z_X(x_0) = \frac{\#\left\{x \in X: x < x_0 \right\}}{\#X}. $$
Mówi ona jaka część liczb ze zbioru $X$ jest poniżej wartości $x_0$. Wykorzystamy ją, by policzyć jaka część państw jest poniżej wartości każdej zmiennej dla Polski. Statystyki te wyliczymy dla roku 2014, ponieważ w roku 2015 występuje sporo braków danych.

```{r polska_porownanie}
pol <- data2014 %>% filter(country == "Poland")
stats <- c()

for (column in colnames(data)[4:22]) {
    F <- ecdf(data2014[,column])
    stats <- append(stats, round(F(pol[column]), 2))
}

df <- data.frame(colnames(data)[4:22], stats)
colnames(df) <- c("Zmienna", "Wartość statystyki Z")
kable(df)
```

Przypomnijmy, że zmienne wpływające pozytywnie na długość życia to BMI, zasięg szczepień na błonicę oraz polio, PKB, średni czas nauczania i wskaźnik rozwoju społecznego. Na powyższej tabeli zauważymy, że z wymienionych zmiennych najniższą wartość ma statystyka obliczona dla szczepień na polio i wynosi ona 0.55, co stawia nasz kraj lekko powyżej połowy. Stąd, aby zwiększyć długość życia Polaków, państwo mogłoby zwiększyć zasięg szczepień na wspomnianą chorobę.

Natomiast zmiennymi skorelowanymi ujemnie są zmienne związane ze śmiertelnością oraz niedowagą. W tabeli zobaczymy, że śmiertelność u dorosłych w Polsce jest bardzo niska, jednak śmiertelność w przypadku niemowląt i dzieci poniżej 5-tego roku życia stawia nasze państwo mnniej więcej po środku w stosunku do reszty świata. Z kolei watości statystyki $Z$ dla kolumn dotyczących niedowagi mieszczą się w okolicach 0.35, co także nie jest najlepszym wynikiem. Dobrą strategią byłoby zatem zapobieganie zgonów u małych dzieci w pierwszej kolejności, a następnie walka z niedowagą.

Wartość statystyki $Z$ dla średniego czasu edukacji wynosi 0.91, co stawia Polskę bardzo wysoko. Nie jest to jednak argument za tym, by zaprzestać inwestowanie w nauczanie. Jak zostało pokazane wcześniej, edukacja ma duży wpływ na długość życia. W Polsce średni czas nauczania w 2014 roku wynosił 16.4 lat. Przypuśćmy, że czas ten zostałby wydłużony do 18 lat. Skorzystamy teraz z wcześniej wyznaczonej regresji liniowej dla zależności pomiędzy czasem nauki, a czasem życia, by wyznaczyć przedział ufności.


# Podsumowanie
